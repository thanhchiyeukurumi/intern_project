<div class="post-detail-page" ngSkipHydration>

  <!-- Main Content Area -->
  <div class="main-content-container">
    <div nz-row [nzGutter]="[32, 32]">

      <!-- Post Content Column (Left) -->
      <div nz-col [nzXs]="24" [nzLg]="16">
        <!-- Skeleton Loading cho bài viết -->
        <ng-container *ngIf="isLoading">
          <div class="post-content-area skeleton-padding">
            <nz-skeleton [nzActive]="true" [nzAvatar]="{size: 'large'}" [nzParagraph]="{ rows: 10 }"></nz-skeleton>
          </div>
        </ng-container>

        <!-- Bài viết không tồn tại -->
        <ng-container *ngIf="!isLoading && !post">
          <nz-card class="not-found-card">
            <h2 nz-typography>Không tìm thấy bài viết</h2>
            <p nz-typography nzType="secondary">Bài viết bạn đang tìm kiếm không tồn tại hoặc không thể tải.</p>
            <a routerLink="/home" nz-button nzType="primary">Quay lại trang chủ</a>
          </nz-card>
        </ng-container>

        <!-- Nội dung bài viết -->
        <ng-container *ngIf="!isLoading && post">
          <article class="post-content-area">
            <!-- Header bài viết -->
            <header class="post-header">
              <!-- Danh mục -->
              <div class="post-categories" *ngIf="post.categories && post.categories.length > 0">
                <a *ngFor="let category of post.categories" 
                   [routerLink]="['/categories', category.id]" 
                   class="post-category">
                  {{ category.name }}
                </a>
              </div>

              <!-- Tiêu đề bài viết -->
              <h1 nz-typography class="post-title animate-in">{{ post.title }}</h1>
              
              <!-- Thông tin tác giả và ngày đăng -->
              <div class="post-meta">
                <div class="author-info">
                  <a [routerLink]="post.author.profileLink">
                    <nz-avatar [nzSize]="40" [nzSrc]="post.author.avatarUrl" nzIcon="user"></nz-avatar>
                  </a>
                  <div class="meta-text">
                    <a class="author-name" [routerLink]="post.author.profileLink">{{ post.author.name }}</a>
                    <span nz-typography nzType="secondary" class="publish-details">
                      Đăng ngày {{ post.publishedDate }} 
                      <span class="separator">·</span> 
                      {{ post.readTimeMinutes }} phút đọc
                    </span>
                  </div>
                </div>
                
                <!-- Chia sẻ bài viết -->
                <div class="post-actions">
                  <button nz-button nzType="text" class="share-button" (click)="sharePost()">
                    <span nz-icon nzType="share-alt" nzTheme="outline"></span>
                    Chia sẻ
                  </button>
                </div>
              </div>
            </header>

            <!-- Nội dung bài viết -->
            <div class="post-body animate-body" [innerHTML]="post.content | safeHtml"></div>

            <!-- Footer bài viết: tags, bình luận, v.v. -->
            <footer class="post-footer">
              <!-- Tags bài viết -->
              <div class="post-tags" *ngIf="post.tags && post.tags.length > 0">
                <div class="tags-label"><span nz-icon nzType="tag" nzTheme="outline"></span> Tags:</div>
                <div class="tags-list">
                  <nz-tag *ngFor="let tag of post.tags" class="post-tag-item">{{ tag }}</nz-tag>
                </div>
              </div>
              
              <nz-divider></nz-divider>
              
              <!-- Phần bình luận -->
              <div class="comments-section">
                <h3 nz-typography class="section-title">
                  <span nz-icon nzType="comment" nzTheme="outline"></span>
                  Bình luận ({{ comments.length }})
                </h3>
                
                <!-- Form thêm bình luận mới -->
                <div class="add-comment-form" [class.login-required]="!isLoggedIn">
                  <div *ngIf="!isLoggedIn" class="login-prompt">
                    <p>Vui lòng đăng nhập để bình luận</p>
                    <a routerLink="/login" nz-button nzType="primary">Đăng nhập</a>
                  </div>
                  
                  <nz-form-item *ngIf="isLoggedIn">
                    <nz-textarea-count [nzMaxCharacterCount]="500">
                      <textarea 
                        class="text-area-form"
                        rows="4"
                        nz-input 
                        [(ngModel)]="commentContent"
                        placeholder="Chia sẻ suy nghĩ của bạn về bài viết này..."></textarea>
                    </nz-textarea-count>
                  </nz-form-item>
                  
                  <div class="comment-action-buttons" *ngIf="isLoggedIn">
                    <button 
                      nz-button 
                      nzType="primary" 
                      [nzLoading]="submittingComment"
                      [disabled]="!isCommentValid() || submittingComment" 
                      (click)="submitComment()">
                      Đăng bình luận
                    </button>
                  </div>
                </div>
                
                <!-- Danh sách bình luận -->
                <nz-spin [nzSpinning]="isLoadingComments">
                  <ng-container *ngIf="comments.length > 0">
                    <div class="comments-list">
                      <nz-comment 
                        *ngFor="let comment of comments; let i = index"
                        [nzAuthor]="comment.User?.username || 'Người dùng ẩn danh'"
                        [nzDatetime]="formatCommentDate(comment.created_at || comment.createdAt)"
                        [class.animate-comment]="true"
                        [style.animation-delay]="i * 0.1 + 's'">
                        
                        <nz-avatar
                          nz-comment-avatar
                          nzIcon="user"
                          [nzSrc]="comment.User?.avatar || 'assets/images/default-avatar.png'"
                        ></nz-avatar>
                        
                        <nz-comment-content>
                          <p>{{ comment.content }}</p>
                        </nz-comment-content>
                      </nz-comment>
                    </div>
                  </ng-container>
                  
                  <!-- Không có bình luận -->
                  <nz-empty 
                    *ngIf="!isLoadingComments && comments.length === 0"
                    nzNotFoundContent="Chưa có bình luận nào. Hãy trở thành người đầu tiên bình luận!"
                    class="empty-comments">
                  </nz-empty>
                </nz-spin>
              </div>
            </footer>
          </article>
        </ng-container>
      </div>

      <!-- Sidebar Column (Right - Sticky) -->
      <div nz-col [nzXs]="0" [nzLg]="8">
        <div class="sidebar-sticky-content">
          <!-- Thông tin tác giả (Card mới) -->
          <ng-container *ngIf="!isLoading && post">
            <nz-card class="sidebar-card author-card animate-in" [nzBordered]="false">
              <div class="author-header">
                <nz-avatar [nzSize]="64" [nzSrc]="post.author.avatarUrl" nzIcon="user"></nz-avatar>
                <div class="author-name-container">
                  <h3 class="author-name">{{ post.author.name }}</h3>
                  <a [routerLink]="post.author.profileLink" class="author-profile-link">Xem hồ sơ</a>
                </div>
              </div>
              <div class="author-bio">
                <p>Tác giả của bài viết. Theo dõi để cập nhật các bài viết mới nhất.</p>
              </div>
              <!-- <div class="author-actions">
                <button nz-button nzType="primary">Theo dõi</button>
              </div> -->
            </nz-card>
          </ng-container>

          <!-- Bài viết đề xuất -->
          <nz-card class="sidebar-card" [nzTitle]="recommendedTitle" [nzBordered]="false">
            <ng-template #recommendedTitle>
              <h3 class="sidebar-card-title">
                <span nz-icon nzType="read" nzTheme="outline"></span>
                Bài viết đề xuất
              </h3>
            </ng-template>

            <!-- Loading State -->
            <nz-list *ngIf="isLoading">
              <nz-list-item *ngFor="let i of [1, 2, 3]">
                <nz-skeleton [nzActive]="true" [nzAvatar]="false" [nzTitle]="false" [nzParagraph]="{ rows: 2 }"></nz-skeleton>
              </nz-list-item>
            </nz-list>

            <!-- Loaded State -->
            <nz-list 
              *ngIf="!isLoading && recommendedPosts.length > 0" 
              [nzDataSource]="recommendedPosts" 
              [nzRenderItem]="recommendedItem" 
              [nzSplit]="false">
              <ng-template #recommendedItem let-item>
                <nz-list-item class="recommended-post-item animate-item">
                  <a [routerLink]="item.postLink" class="item-link">
                    <h4 class="item-title">{{ item.title }}</h4>
                    <p nz-typography nzType="secondary" class="item-author">{{ item.authorName }}</p>
                  </a>
                </nz-list-item>
              </ng-template>
            </nz-list>

            <!-- Empty State -->
            <div *ngIf="!isLoading && recommendedPosts.length === 0" nz-typography nzType="secondary" class="no-data-message">
              Không có bài viết đề xuất.
            </div>
          </nz-card>

          <!-- Thẻ đặc biệt -->
          <!-- <nz-card class="sidebar-card newsletter-card" [nzBordered]="false">
            <h3 class="sidebar-card-title">
              <span nz-icon nzType="notification" nzTheme="outline"></span>
              Theo dõi cập nhật
            </h3>
            <p class="newsletter-description">Nhận thông báo khi có bài viết mới</p>
            <nz-input-group [nzSuffix]="suffixButton" class="newsletter-input">
              <input type="email" nz-input placeholder="Email của bạn" />
            </nz-input-group>
            <ng-template #suffixButton>
              <button nz-button nzType="primary">
                <span nz-icon nzType="send"></span>
              </button>
            </ng-template>
          </nz-card> -->
        </div>
      </div>

    </div>
  </div>

  <!-- Back to top button -->
  <div class="back-to-top" *ngIf="showBackToTop" (click)="scrollToTop()">
    <span nz-icon nzType="arrow-up" nzTheme="outline"></span>
  </div>
</div>