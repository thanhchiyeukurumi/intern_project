<div class="post-detail-page" ngSkipHydration>

  <!-- Main Content Area -->
  <div class="main-content-container">
    <div nz-row [nzGutter]="[32, 32]">

      <!-- Post Content Column (Left) -->
      <div nz-col [nzXs]="24" [nzLg]="16">
        <ng-container *ngIf="!isLoading && post">
          <article class="post-content-area">
            <!-- Post Header -->
            <header class="post-header">
              <h1 nz-typography class="post-title">{{ post.title }}</h1>
              <div class="post-meta">
                <div class="author-info">
                  <a [routerLink]="post.author.profileLink || null">
                    <nz-avatar [nzSize]="40" [nzSrc]="post.author.avatarUrl" nzIcon="user"></nz-avatar>
                  </a>
                  <div class="meta-text">
                    <a class="author-name" [routerLink]="post.author.profileLink || null">{{ post.author.name }}</a>
                    <span nz-typography nzType="secondary" class="publish-details">
                      Published on {{ post.publishedDate }} <span class="separator">·</span> {{ post.readTimeMinutes }} min read
                    </span>
                  </div>
                </div>
                <!-- Add share buttons or other actions here if needed -->
              </div>
            </header>

            <!-- Post Body -->
            <!-- SECURITY WARNING: Use [innerHTML] only with SANITIZED HTML content. -->
            <!-- The SafeHtmlPipe helps, but ensure the source is trustworthy. -->
            <div class="post-body" [innerHTML]="post.content | safeHtml">
              <!-- Content is rendered here -->
            </div>

            <!-- Post Footer (Tags, Comments Link, etc.) -->
            <footer class="post-footer">
              <div class="post-tags" *ngIf="post.tags && post.tags.length > 0">
                <nz-tag *ngFor="let tag of post.tags" class="post-tag-item">{{ tag }}</nz-tag>
              </div>
              <nz-divider></nz-divider>
              
              <!-- Comment Section -->
              <div class="comments-section">
                <h3 nz-typography>Bình luận</h3>
                
                <!-- Comment List -->
                <ng-container *ngIf="comments.length > 0">
                  <nz-list [nzDataSource]="comments" [nzRenderItem]="commentTemplate" nzItemLayout="horizontal">
                    <ng-template #commentTemplate let-comment>
                      <nz-comment 
                        [nzAuthor]="comment.author.name"
                        [nzDatetime]="comment.createdAt"
                        nzAvatar="comment.author.avatarUrl">
                        <nz-avatar
                          nz-comment-avatar
                          nzIcon="user"
                          nzSrc="//zos.alipayobjects.com/rmsportal/ODTLcjxAfvqbxHnVXCYX.png"
                        ></nz-avatar>
                        <nz-comment-content>
                          <p>{{ comment.content }}</p>
                        </nz-comment-content>
                        
                        <nz-comment-action>
                          <span (click)="toggleReply(comment.id)">
                            <span nz-icon nzType="comment"></span> 
                            <span class="comment-action">Trả lời</span>
                          </span>
                        </nz-comment-action>
                        
                        <!-- Reply Form this shit need to fix--> 
                        <ng-container *ngIf="replyTo === comment.id">
                          <div class="reply-form">
                            <nz-form-item>
                              <nz-textarea-count [nzMaxCharacterCount]="500">
                                <textarea 
                                  rows="3"
                                  nz-input 
                                  [(ngModel)]="replyContent" 
                                  placeholder="Viết trả lời của bạn ở đây..."></textarea>
                              </nz-textarea-count>
                            </nz-form-item>
                            <div class="comment-action-buttons">
                              <button nz-button nzType="default" (click)="cancelReply()">Hủy</button>
                              <button nz-button nzType="primary" [disabled]="!replyContent" (click)="submitReply(comment.id)">Gửi</button>
                            </div>
                          </div>
                        </ng-container>
                      </nz-comment>
                    </ng-template>
                  </nz-list>
                </ng-container>
                
                <!-- Empty State -->
                <nz-empty 
                  *ngIf="!isLoading && comments.length === 0"
                  nzNotFoundContent="Chưa có bình luận nào. Hãy trở thành người đầu tiên bình luận!"
                  class="empty-comments">
                </nz-empty>
                
                <!-- Add New Comment Form -->
                <div class="add-comment-form">
                  <h4 nz-typography>Write comment</h4>
                  <nz-form-item >
                    <nz-textarea-count [nzMaxCharacterCount]="500">
                      <textarea 
                        class="text-area-form"
                        rows="4"
                        nz-input 
                        [(ngModel)]="commentContent"
                        placeholder="Chia sẻ suy nghĩ của bạn về bài viết này..."></textarea>
                    </nz-textarea-count>
                  </nz-form-item>
                  
                  <div class="comment-action-buttons">
                    <button 
                      nz-button 
                      nzType="primary" 
                      [disabled]="!isCommentValid()" 
                      (click)="submitComment()">
                      Đăng bình luận
                    </button>
                  </div>
                </div>
              </div>
            </footer>
          </article>
        </ng-container>

        <!-- Skeleton Loading for Post Content -->
        <ng-container *ngIf="isLoading">
            <div class="post-content-area skeleton-padding">
                <nz-skeleton [nzActive]="true" [nzAvatar]="{size: 'large'}" [nzParagraph]="{ rows: 10 }"></nz-skeleton>
            </div>
        </ng-container>

        <!-- Post Not Found Message -->
        <ng-container *ngIf="!isLoading && !post">
            <nz-card class="not-found-card">
                <h2 nz-typography>Post Not Found</h2>
                <p nz-typography nzType="secondary">The post you are looking for does not exist or could not be loaded.</p>
                <a routerLink="/posts" nz-button nzType="primary">Back to Posts</a> <!-- Adjust link -->
            </nz-card>
        </ng-container>
      </div>

      <!-- Sidebar Column (Right - Sticky) -->
      <div nz-col [nzXs]="0" [nzLg]="8"> <!-- Hidden on small screens -->
        <div class="sidebar-sticky-content">

          <!-- Recommended Posts Card -->
          <nz-card class="sidebar-card" [nzTitle]="recommendedTitle" [nzBordered]="false">
            <ng-template #recommendedTitle>
              <h3 class="sidebar-card-title">Recommended Posts</h3>
            </ng-template>

            <!-- Loading State -->
            <nz-list *ngIf="isLoading">
                <nz-list-item *ngFor="let i of [1, 2, 3]">
                    <nz-skeleton [nzActive]="true" [nzAvatar]="false" [nzTitle]="false" [nzParagraph]="{ rows: 2 }"></nz-skeleton>
                </nz-list-item>
            </nz-list>

            <!-- Data Loaded State -->
             <nz-list *ngIf="!isLoading && recommendedPosts.length > 0" [nzDataSource]="recommendedPosts" [nzRenderItem]="recommendedItem" [nzSplit]="false">
                <ng-template #recommendedItem let-item>
                  <nz-list-item class="recommended-post-item">
                    <a [routerLink]="item.postLink" class="item-link">
                      <h4 class="item-title">{{ item.title }}</h4>
                      <p nz-typography nzType="secondary" class="item-author">{{ item.authorName }}</p>
                    </a>
                  </nz-list-item>
                </ng-template>
             </nz-list>

             <!-- No Data State -->
             <div *ngIf="!isLoading && recommendedPosts.length === 0" nz-typography nzType="secondary" class="no-data-message">
                No recommendations available.
             </div>
          </nz-card>
        </div>
      </div>

    </div>
  </div>
</div>