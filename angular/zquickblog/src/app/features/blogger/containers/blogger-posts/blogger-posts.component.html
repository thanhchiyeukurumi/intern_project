<!-- src/app/pages/blogger/posts/blogger-posts.component.html -->
<nz-card class="blogger-posts-card">
  <div class="header-container">
    <div class="title-section">
      <h2 class="card-title">Bài viết của tôi & Các bản dịch</h2>
      <a routerLink="/blogger/posts/create" nz-button nzType="primary" class="create-button">
        <i nz-icon nzType="plus"></i> Bài viết mới
      </a>
    </div>

    <div class="filter-section">
      <div class="search-container">
        <nz-input-group [nzPrefix]="prefixIconSearch" class="search-input">
          <input
            type="text"
            nz-input
            placeholder="Tìm kiếm bài viết..."
            [(ngModel)]="searchText"
            (ngModelChange)="onSearchInputChange($event)"
            (keyup.enter)="onSearchOrFilterChange()" />
        </nz-input-group>
        <ng-template #prefixIconSearch>
          <i nz-icon nzType="search"></i>
        </ng-template>
      </div>

      <div class="filters">
         <nz-select
           class="filter-select"
           nzPlaceHolder="Tất cả ngôn ngữ"
           [(ngModel)]="filterLanguageId"
           (ngModelChange)="onLanguageFilterChange($event)"
           nzAllowClear>
           <nz-option *ngFor="let lang of languageOptions" [nzValue]="lang.id" [nzLabel]="lang.name"></nz-option>
         </nz-select>
       </div>
    </div>
  </div>

  <div class="table-container">
    <nz-table
      #postsTable
      [nzData]="displayPosts"
      [nzLoading]="loading"
      [nzShowPagination]="false"
      class="blogger-posts-table">
      <thead>
        <tr>
          <th nzWidth="40px"></th> <!-- Cột cho nút expand -->
          <th nzWidth="30%">Tiêu đề</th>
          <th>Ngày đăng</th>
          <th>Ngôn ngữ</th>
          <th>Danh mục</th>
          <th>Lượt xem</th>
          <th [nzAlign]="'right'">Hành động</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let post of postsTable.data"> <!-- post ở đây là PostForDisplay -->
          <!-- Hàng của bài viết gốc -->
          <tr [class.expanded-row-parent]="post.expand">
            <!-- Nút Expand -->
            <td
              [nzExpand]="post.expand"
              (click)="toggleExpand(post)"> <!-- Gọi toggleExpand thay vì nzExpandChange -->
            </td>

            <!-- Title & Translations count -->
            <td>
              <div class="post-title-container">
                <a [routerLink]="['/blogger/posts/edit', post.id]" class="post-title" nz-tooltip [nzTooltipTitle]="post.title">
                  <nz-typography [nzEllipsis]="true">{{ post.title }}</nz-typography>
                </a>
                <div class="post-tags">
                  <ng-container *ngIf="post.translations && post.translations.length > 0">
                    <nz-tag nzColor="blue" class="translation-count-tag">
                      {{ post.translations.length }} bản dịch
                    </nz-tag>
                  </ng-container>
                  <nz-tag *ngIf="post.loadingTranslations" nzColor="geekblue">
                    <i nz-icon nzType="loading"></i>
                  </nz-tag>
                </div>
              </div>
            </td>
            <!-- Published Date -->
            <td>
              <ng-container *ngIf="post.updatedAt"> <!-- Nên dùng updatedAt nếu có publish date riêng -->
                  {{ post.updatedAt | date:'dd/MM/yyyy' }}
              </ng-container>
              <ng-container *ngIf="!post.updatedAt">
                  -
              </ng-container>
            </td>
            <!-- Language -->
            <td>
                <!-- Sử dụng post.Language từ model Post -->
                <nz-tag *ngIf="post.Language" class="language-tag">{{ post.Language.name }}</nz-tag>
                <span *ngIf="!post.Language">-</span>
            </td>
            <!-- Category -->
            <td>
              <div class="category-tags">
                <!-- Sử dụng post.Categories từ model Post -->
                <ng-container *ngIf="post.Categories && post.Categories.length > 0">
                  <nz-tag *ngFor="let cat of post.Categories" [nzColor]="getCategoryColor(cat.name)">{{ cat.name }}</nz-tag>
                </ng-container>
                <span *ngIf="!post.Categories || post.Categories.length === 0">-</span>
              </div>
            </td>
            <!-- Views -->
            <td>
              <div class="views-count">
                <span nz-icon nzType="eye"></span>{{ post.views || 0 }}
              </div>
            </td>
            <!-- Actions -->
            <td [nzAlign]="'right'" class="action-buttons">
              <a nz-button nzType="link" nzSize="small" [routerLink]="['/blogger/posts/edit', post.id]" nzTooltipTitle="Sửa bài gốc" nz-tooltip>
                <span nz-icon nzType="edit"></span>
              </a>

              <a nz-button nzType="link" nzSize="small" [routerLink]="['/post', post.slug || post.id]" target="_blank" nzTooltipTitle="Xem bài gốc" nz-tooltip>
                <span nz-icon nzType="eye"></span>
              </a>

              <!-- Sử dụng hàm confirm mới -->
              <button nz-button nzType="link" nzSize="small" nzDanger
                      (click)="confirmDeleteOriginalPost(post)"
                      nzTooltipTitle="Xóa bài gốc & các bản dịch" nz-tooltip>
                <span nz-icon nzType="delete"></span>
              </button>

              <button nz-button nzType="primary" nzSize="small" nzShape="circle" (click)="addLanguageVariant(post.id)" nzTooltipTitle="Thêm bản dịch" nz-tooltip>
                <span nz-icon nzType="translation"></span>
              </button>
            </td>
          </tr>

          <!-- Hiển thị loading translations -->
          <tr *ngIf="post.expand && post.loadingTranslations" class="translation-row">
            <td></td> <!-- Cột trống để căn lề -->
            <td colspan="6" class="loading-cell">
              <div class="loading-translations">
                <i nz-icon nzType="loading" nzSpin></i> <span>Đang tải các bản dịch...</span>
              </div>
            </td>
          </tr>

          <!-- Hiển thị trạng thái trống khi không có bản dịch -->
          <tr *ngIf="post.expand && !post.loadingTranslations && (!post.translations || post.translations.length === 0)" class="translation-row">
            <td></td> <!-- Cột trống để căn lề -->
            <td colspan="6" class="empty-cell">
              <div class="empty-state">
                <span>Chưa có bản dịch nào.</span>
                <button nz-button nzType="primary" nzSize="small" (click)="addLanguageVariant(post.id)">
                  <i nz-icon nzType="plus"></i> Thêm bản dịch đầu tiên
                </button>
              </div>
            </td>
          </tr>

          <!-- Hiển thị các hàng bản dịch -->
          <ng-container *ngIf="post.expand && !post.loadingTranslations && post.translations && post.translations.length > 0">
            <tr class="translation-action-row">
              <td></td> <!-- Cột trống để căn lề -->
              <td colspan="6" class="translation-action-cell">
                <div class="translation-action">
                  <span class="translation-label">Bản dịch ({{ post.translations.length }})</span>
                  <button nz-button nzType="primary" nzSize="small" (click)="addLanguageVariant(post.id)">
                    <i nz-icon nzType="plus"></i> Thêm bản dịch
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngFor="let variant of post.translations" class="translation-row">
              <td></td> <!-- Cột trống để căn lề -->
              <td>
                <div class="post-title-container">
                  <a [routerLink]="['/blogger/posts/edit', variant.id]" class="post-title" nz-tooltip [nzTooltipTitle]="variant.title">
                    <nz-typography [nzEllipsis]="true">{{ variant.title }}</nz-typography>
                  </a>
                  <div class="language-indicator">
                    <nz-tag *ngIf="variant.Language" class="language-tag">{{ variant.Language.name }}</nz-tag>
                  </div>
                </div>
              </td>
              <td>
                <ng-container *ngIf="variant.updatedAt">
                  {{ variant.updatedAt | date:'dd/MM/yyyy' }}
                </ng-container>
                <ng-container *ngIf="!variant.updatedAt">
                  -
                </ng-container>
              </td>
              <td>
                <nz-tag *ngIf="variant.Language" class="language-tag">{{ variant.Language.name }}</nz-tag>
                <span *ngIf="!variant.Language">-</span>
              </td>
              <td>
                <div class="category-tags">
                  <ng-container *ngIf="variant.Categories && variant.Categories.length > 0">
                    <nz-tag *ngFor="let cat of variant.Categories" [nzColor]="getCategoryColor(cat.name)">{{ cat.name }}</nz-tag>
                  </ng-container>
                  <span *ngIf="!variant.Categories || variant.Categories.length === 0">-</span>
                </div>
              </td>
              <td>
                <div class="views-count">
                  <span nz-icon nzType="eye"></span> {{ variant.views || 0 }}
                </div>
              </td>
              <td [nzAlign]="'right'" class="action-buttons">
                <a nz-button nzType="link" nzSize="small" [routerLink]="['/blogger/posts/edit', variant.id]" nzTooltipTitle="Sửa bản dịch" nz-tooltip>
                  <span nz-icon nzType="edit"></span>
                </a>
                
                <a nz-button nzType="link" nzSize="small" [routerLink]="['/post', variant.slug || variant.id]" target="_blank" nzTooltipTitle="Xem bản dịch" nz-tooltip>
                  <span nz-icon nzType="eye"></span>
                </a>

                <button nz-button nzType="link" nzSize="small" nzDanger
                        (click)="confirmDeleteLanguageVariant(post, variant)"
                        nzTooltipTitle="Xóa bản dịch" nz-tooltip>
                  <span nz-icon nzType="delete"></span>
                </button>
              </td>
            </tr>
          </ng-container>
        </ng-container>
      </tbody>
        <nz-empty *ngIf="!loading && displayPosts.length === 0" nzNotFoundContent="Không tìm thấy bài viết nào."></nz-empty>
    </nz-table>
  </div>

  <div class="pagination-container" *ngIf="!loading && total > 0">
    <div class="pagination-info" [innerHTML]="getPaginationInfo()"></div>
    <nz-pagination
      [(nzPageIndex)]="pageIndex"
      [(nzPageSize)]="pageSize"
      [nzTotal]="total"
      nzShowSizeChanger
      (nzPageIndexChange)="onPageIndexChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzPageSizeOptions]="[10, 20, 50]">
    </nz-pagination>
  </div>
</nz-card>